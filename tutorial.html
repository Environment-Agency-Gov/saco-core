

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tutorial &mdash; saco  documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=5929fcd5"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Table Fields" href="fields.html" />
    <link rel="prev" title="Optimiser" href="optimiser.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            saco
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Background:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="data.html">Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="calculator.html">Calculator</a></li>
<li class="toctree-l1"><a class="reference internal" href="optimiser.html">Optimiser</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#imports">Imports</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dataset">Dataset</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#tables">Tables</a></li>
<li class="toctree-l3"><a class="reference internal" href="#changing-numbers">Changing Numbers</a></li>
<li class="toctree-l3"><a class="reference internal" href="#other-functionality">Other Functionality</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#calculator">Calculator</a></li>
<li class="toctree-l2"><a class="reference internal" href="#optimiser">Optimiser</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#dataset-preparation">Dataset Preparation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#optional-arguments">Optional Arguments</a></li>
<li class="toctree-l3"><a class="reference internal" href="#outputs">Outputs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#complex-impacts">Complex Impacts</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="fields.html">Table Fields</a></li>
<li class="toctree-l1"><a class="reference internal" href="reference-dataset.html">Dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="reference-calculate.html">Calculator</a></li>
<li class="toctree-l1"><a class="reference internal" href="reference-optimise.html">Optimiser</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">saco</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Tutorial</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/tutorial.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="tutorial">
<h1>Tutorial<a class="headerlink" href="#tutorial" title="Link to this heading"></a></h1>
<p>This section introduces the code in the package and how it might be used. It is best to
read the preceding sections of the documentation first to get a more detailed
introduction to the tool components. See the Jupyter notebooks in the examples folder
of the repository for further code examples.</p>
<section id="imports">
<h2>Imports<a class="headerlink" href="#imports" title="Link to this heading"></a></h2>
<p>The first step in using SACO is importing it as a package into a script/notebook. The
most important functionality becomes available with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">saco</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">Calculator</span><span class="p">,</span> <span class="n">Optimiser</span>
</pre></div>
</div>
<p>From this we can see that the three most important components that a user might
interact with are:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Dataset</span></code>: provides a “container” to group and manipulate multiple data tables.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Calculator</span></code>: takes a <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> as input, calculates “scenario flows” and
assesses their compliance against environmental flow targets.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Optimiser</span></code>: takes a <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> as input then formulates and solves an
optimisation problem to find abstraction impact reductions needed to meet flow
targets.</p></li>
</ul>
</div></blockquote>
<p>We provide an initial guide to these objects/components below. See the “Reference”
sections of the documentation for further details, including information about additional
helper functions.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The backgrounds to the Calculator and Optimiser components are explained in more
detail in the <a class="reference internal" href="calculator.html"><span class="doc">Calculator</span></a> and <a class="reference internal" href="optimiser.html"><span class="doc">Optimiser</span></a> sections of the documentation.</p>
</div>
</section>
<section id="dataset">
<h2>Dataset<a class="headerlink" href="#dataset" title="Link to this heading"></a></h2>
<p>A <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> is primarily used to store and group together the relevant data tables
(i.e. primarily WRGIS tables). One way to get going with a <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> (and the tool
in general) is to load a folder of data table files:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ds</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">data_folder</span><span class="o">=</span><span class="s1">&#39;/path/to/my/data-folder&#39;</span><span class="p">)</span>
<span class="n">ds</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
</pre></div>
</div>
<p>Here we have created a <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> object (as <code class="docutils literal notranslate"><span class="pre">ds</span></code>) and loaded data into memory. As a
<code class="docutils literal notranslate"><span class="pre">Dataset</span></code> object is the main input to the Calculator and Optimiser components of the
tool, we could actually now go ahead and run those components. But first let us look a
bit more into what a <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> consists of.</p>
<section id="tables">
<h3>Tables<a class="headerlink" href="#tables" title="Link to this heading"></a></h3>
<p>A Dataset object has individual data tables as its most important attributes. For example,
<code class="docutils literal notranslate"><span class="pre">ds.swabs</span></code> provides access to the SWABS_NBB table of surface water abstractions from
WRGIS (with “swabs” being the “short name” for SWABS_NBB). Similar attributes exist for
the other key WRGIS tables listed below:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">asbs</span></code>: AbsSensBands_NBB (waterbody abstraction sensitivity bands)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">asb_percs</span></code>: ASBPercentages (fractional deviations defining the reference flows
- typically environmental flow indicator, EFI)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dis</span></code>: Discharges_NBB (point surface water discharges)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">gwabs</span></code>: GWABs_NBB (point groundwater abstractions)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">qnat</span></code>: QNaturalFlows_NBB (waterbody natural flows)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">refs</span></code>: REFS_NBB (reference flows - typically EFI)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sup</span></code>: SupResGW_NBB (point “complex impacts”)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">swabs</span></code>: SWABS_NBB (point surface water abstractions)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">wbs</span></code>: IntegratedWBs_NBB (waterbody metadata)</p></li>
</ul>
</div></blockquote>
<p>An additional table that is not in WRGIS is derived and included in a <code class="docutils literal notranslate"><span class="pre">Dataset</span></code>:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">mt</span></code>: Master (waterbody summary table - water balance terms, compliance, etc)</p></li>
</ul>
</div></blockquote>
<p>The Master table is intended to be the key waterbody-level table that brings together
the water balance components with information on surplus/deficit and compliance
classifications.</p>
<p>The tables have various properties, but most importantly each table class possesses a
<code class="docutils literal notranslate"><span class="pre">data</span></code> attribute, which is a pandas.DataFrame. Therefore, to access the dataframe of
surface water abstractions, we can use <code class="docutils literal notranslate"><span class="pre">ds.swabs.data</span></code>. We can then query or
manipulate the data table as we would any pandas.DataFrame. A description of the column
indexes and fields is given in <a class="reference internal" href="fields.html"><span class="doc">Table Fields</span></a>.</p>
</section>
<section id="changing-numbers">
<h3>Changing Numbers<a class="headerlink" href="#changing-numbers" title="Link to this heading"></a></h3>
<p>A user may wish to changes numbers in a <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> to improve the data or to test the
implications of known, planned, hypothetical or other types of prescribed changes. Two
ways to change the numbers in a <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> are:</p>
<blockquote>
<div><ul class="simple">
<li><p>Modify the numbers in data table files on disk and then load the <code class="docutils literal notranslate"><span class="pre">Dataset</span></code>
using syntax like the <code class="docutils literal notranslate"><span class="pre">load_data</span></code> example above.</p></li>
<li><p>Modify a dataframe directly using a table’s <code class="docutils literal notranslate"><span class="pre">data</span></code> attribute, as described in
the preceding paragraph.</p></li>
</ul>
</div></blockquote>
<p>An example of the latter approach to change a surface water abstraction impact would be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ds</span><span class="o">.</span><span class="n">swabs</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ds</span><span class="o">.</span><span class="n">swabs</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="s1">&#39;swab-unique-id&#39;</span><span class="p">,</span> <span class="s1">&#39;SWQ95FLWR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.23</span>
</pre></div>
</div>
<p>This would change the abstraction impact under the fully licensed (FL) artificial
influences scenario at the 95th (natural) flow percentile to 1.23 (Ml/d). But the
dataframe could be queried or manipulated in different ways, including through pandas
merge/join operations etc.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The Master (<code class="docutils literal notranslate"><span class="pre">mt</span></code>) table and its data should not be set or edited directly by a
typical user (in general). See below about (1) using the Calculator to obtain an
updated Master table and (2) using specific methods to ensure that a Dataset and
its Master table are ready to go into the Optimiser.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If a user changes a surface or groundwater abstraction impact in a <code class="docutils literal notranslate"><span class="pre">Dataset</span></code>
under a given artificial influences scenario and at a given (natural) flow
percentile, any long-term average abstraction columns in the relevant table are
<em>not</em> automatically updated (currently). See <a class="reference internal" href="reference-dataset.html"><span class="doc">Dataset</span></a> for
explanation of the available options to make this calculation if needed.</p>
</div>
</section>
<section id="other-functionality">
<h3>Other Functionality<a class="headerlink" href="#other-functionality" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> possesses additional functionality to help set table values, write
tables to output files, work with the “network” of waterbodies, and prepare for input
to the Optimiser component. This functionality (the “methods” of <code class="docutils literal notranslate"><span class="pre">Dataset</span></code>) are
described in <a class="reference internal" href="reference-dataset.html"><span class="doc">Dataset</span></a>.</p>
</section>
</section>
<section id="calculator">
<h2>Calculator<a class="headerlink" href="#calculator" title="Link to this heading"></a></h2>
<p>Once a <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> has been loaded or constructed (potentially with modifications
relative to the “base” WRGIS), it can be supplied as input to the <code class="docutils literal notranslate"><span class="pre">Calculator</span></code>. As
demonstrated below, the <code class="docutils literal notranslate"><span class="pre">run</span></code> method of the <code class="docutils literal notranslate"><span class="pre">Calculator</span></code> can then be executed to
calculate scenario flows, surpluses/deficits and compliance bands based on the input
<code class="docutils literal notranslate"><span class="pre">Dataset</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">calculator</span> <span class="o">=</span> <span class="n">Calculator</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
<span class="n">output_dataset</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>In the example above we rely on default arguments, which will run the <code class="docutils literal notranslate"><span class="pre">Calculator</span></code>
for all scenario/percentile combinations and for the whole domain in the input
<code class="docutils literal notranslate"><span class="pre">Dataset</span></code> (i.e. all waterbodies present). It will also run with some default
methodological choices (see below for more on this).</p>
<p>By default, the <code class="docutils literal notranslate"><span class="pre">run</span></code> method returns a complete <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> with an updated Master
table (i.e. one that is consistent with all the other tables in the <code class="docutils literal notranslate"><span class="pre">Dataset</span></code>). If we
want to save this <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> (i.e. all of its component tables) at this point, we could
do so as follows (see <a class="reference internal" href="reference-dataset.html"><span class="doc">Dataset</span></a> for guidance on output options):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">output_dataset</span><span class="o">.</span><span class="n">write_tables</span><span class="p">(</span><span class="n">output_folder</span><span class="o">=</span><span class="s1">&#39;/my/output/folder&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>However, if we want to customise the execution of the <code class="docutils literal notranslate"><span class="pre">Calculator</span></code>, we can provide
optional arguments, as described in <a class="reference internal" href="reference-calculate.html"><span class="doc">Calculator</span></a>. One such argument
defined on initialisation of the <code class="docutils literal notranslate"><span class="pre">Calculator</span></code> is named <code class="docutils literal notranslate"><span class="pre">capping_method</span></code>. This
argument controls the approach to “unfeasible” impacts - prescribed abstraction impacts
that cannot be satisfied. See <a class="reference internal" href="calculator.html"><span class="doc">Calculator</span></a> for a more precise explanation of this
point. By default, the Calculator takes a WRGIS-like approach to this issue. Using the
<a class="reference internal" href="reference-calculate.html"><span class="doc">Calculator</span></a> documentation to understand the available options, we could
override the default and take WBAT-like approach as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">calculator</span> <span class="o">=</span> <span class="n">Calculator</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">capping_method</span><span class="o">=</span><span class="s1">&#39;simple&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>We might then for example ask the <code class="docutils literal notranslate"><span class="pre">Calculator.run</span></code> method to return only an updated
Master table as a pandas.DataFrame:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">updated_master_table</span> <span class="o">=</span> <span class="n">calculator</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">master_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>These are just a couple of examples of customisation via optional arguments - see
<a class="reference internal" href="reference-calculate.html"><span class="doc">Calculator</span></a> for more options and details.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If capping has been applied to avoid propagation of unfeasible impacts, scenario
flows output from the Calculator may be larger than initially expected from
performing a simple “ups” water balance calculation for some waterbodies. This is
because capping reduced net impacts upstream to retain physical plausibility. The
Master table gives the “target” artificial influences components, which are not
capped individually.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Any long-term average fields in a <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> passed to the <code class="docutils literal notranslate"><span class="pre">Calculator</span></code> are <em>not</em>
changed by the execution of the <code class="docutils literal notranslate"><span class="pre">Calculator.run</span></code> method currently (i.e. they are
unchanged in the <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> or Master table returned).</p>
</div>
</section>
<section id="optimiser">
<h2>Optimiser<a class="headerlink" href="#optimiser" title="Link to this heading"></a></h2>
<p>The role of the Optimiser is to suggest how impacts could best be adjusted to meet flow
targets, given some objective(s) and constraints. The solution to this problem is
obtained via mixed integer (binary) linear programming.</p>
<section id="dataset-preparation">
<h3>Dataset Preparation<a class="headerlink" href="#dataset-preparation" title="Link to this heading"></a></h3>
<p>The starting point for the <code class="docutils literal notranslate"><span class="pre">Optimiser</span></code> is again a <code class="docutils literal notranslate"><span class="pre">Dataset</span></code>. However, in this case
we need to ensure that certain columns are present in some tables - columns that are not
necessarily relevant to the <code class="docutils literal notranslate"><span class="pre">Calculator</span></code>. The relevant tables and columns are
(currently):</p>
<blockquote>
<div><ul class="simple">
<li><p>Master table: requires a flow target column(s) (optional for the Calculator).</p></li>
<li><p>GWABs_NBB table: requires a flag column to indicate whether a given impact (row)
should be available for change in the optimisation (1) or not (0).</p></li>
<li><p>SWABS_NBB table: as per GWABs_NBB table.</p></li>
<li><p>SupResGW_NBB table: requires a flag column - we return to this below.</p></li>
</ul>
</div></blockquote>
<p>See <a class="reference internal" href="fields.html"><span class="doc">Table Fields</span></a> for a guide to the naming conventions for these columns.</p>
<p>The relevant columns can be added or set using the methods in the example snippet below
(assuming still that we have a <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> instance as <code class="docutils literal notranslate"><span class="pre">ds</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ds</span><span class="o">.</span><span class="n">set_flow_targets</span><span class="p">()</span>
<span class="n">ds</span><span class="o">.</span><span class="n">set_optimise_flag</span><span class="p">()</span>
</pre></div>
</div>
<p>Called in this way, both of these methods will use their default settings, which are
described in <a class="reference internal" href="reference-dataset.html"><span class="doc">Dataset</span></a>. Both methods have optional arguments that can be
used to customise flow targets and flag which abstraction impacts will be
included/excluded in optimisation.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If any further manipulation of the inclusion/exclusion flag is needed it could be
achieved by working with the relevant dataframes (i.e. <code class="docutils literal notranslate"><span class="pre">ds.swabs.data</span></code>,
<code class="docutils literal notranslate"><span class="pre">ds.gwabs.data</span></code> and <code class="docutils literal notranslate"><span class="pre">ds.sup.data</span></code>).</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For users interested in Environmental Destination (ED) modelling, it should be noted
that the default behaviour of the <code class="docutils literal notranslate"><span class="pre">Dataset.set_optimise_flag</span></code> method does not
mimic exactly the configuration used in ED modelling for the second National
Framework for Water Resources. It is important for a user to check that they are
happy with the flag setup.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Waterbody targets can be (optionally) specified via a separate <em>Fix_Flags</em> table
that sits within a <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> (accessible via the short name <code class="docutils literal notranslate"><span class="pre">wbfx</span></code>). If present
in a <code class="docutils literal notranslate"><span class="pre">Dataset</span></code>, the flags in this table will be used to customise flow targets
(i.e. permitting further relaxation beyond the flow in REFS_NBB). See <a class="reference internal" href="fields.html"><span class="doc">Table Fields</span></a>
for more details.</p>
</div>
</section>
<section id="optional-arguments">
<h3>Optional Arguments<a class="headerlink" href="#optional-arguments" title="Link to this heading"></a></h3>
<p>Once we are happy that a <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> is ready for the <code class="docutils literal notranslate"><span class="pre">Optimiser</span></code>, we could invoke the
run method of the <code class="docutils literal notranslate"><span class="pre">Optimiser</span></code> as below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">optimiser</span> <span class="o">=</span> <span class="n">Optimiser</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
<span class="n">output_dataset</span> <span class="o">=</span> <span class="n">optimiser</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="n">output_dataset</span><span class="o">.</span><span class="n">write_tables</span><span class="p">(</span><span class="n">output_folder</span><span class="o">=</span><span class="s1">&#39;/my/output/folder&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>However, the <a class="reference internal" href="reference-optimise.html"><span class="doc">Optimiser</span></a> section provides information on options that we
may want to customise when setting up the <code class="docutils literal notranslate"><span class="pre">Optimiser</span></code> (i.e. before execution). One
such option concerns the geographical domain considered. By default, the code above
will run the <code class="docutils literal notranslate"><span class="pre">Optimiser</span></code> for the whole domain contained in the input <code class="docutils literal notranslate"><span class="pre">Dataset</span></code>. The
following lines provide an example of how to run for only part of the domain (referring
to the most downstream waterbody of interest as an “outlet”):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">outlet_waterbody</span> <span class="o">=</span> <span class="s1">&#39;outlet-waterbody-id&#39;</span>  <span class="c1"># could be a list of outlet waterbodies</span>

<span class="n">selected_waterbodies</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">identify_upstream_waterbodies</span><span class="p">(</span><span class="n">outlet_waterbody</span><span class="p">)</span>

<span class="n">optimiser</span> <span class="o">=</span> <span class="n">Optimiser</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">selected_waterbodies</span><span class="p">)</span>
<span class="n">output_dataset</span> <span class="o">=</span> <span class="n">optimiser</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>Other options can be specified too, such as which artificial influences scenario(s) and
flow percentile(s) should be considered. Options also exist concerning the objectives
of the optimisation and whether any “relaxation” should be applied when attempting to
solve for a secondary objective - see <a class="reference internal" href="optimiser.html"><span class="doc">Optimiser</span></a>.</p>
</section>
<section id="outputs">
<h3>Outputs<a class="headerlink" href="#outputs" title="Link to this heading"></a></h3>
<p>The contents of the output from <code class="docutils literal notranslate"><span class="pre">Optimiser.run</span></code> are similar to a normal <code class="docutils literal notranslate"><span class="pre">Dataset</span></code>,
apart from (keeping complex impacts to one side for the moment):</p>
<blockquote>
<div><ul class="simple">
<li><p>The SWABS_NBB and GWABs_NBB tables now contain abstraction impacts as they are
the optimisation has been completed (i.e. the impacts that remain after the
“fix”).</p></li>
<li><p>Similarly, the Master table summarises the water balance and compliance etc for
the solution formulated by the <code class="docutils literal notranslate"><span class="pre">Optimiser</span></code>.</p></li>
<li><p>Additional tables are present: SWABS_Changes and GWABS_Changes (accessible via
the output <code class="docutils literal notranslate"><span class="pre">Dataset</span></code>’s attributes <code class="docutils literal notranslate"><span class="pre">swabs_chg</span></code> and <code class="docutils literal notranslate"><span class="pre">gwab_chg</span></code>, respectively.
These tables contain the impact reductions (Ml/d) required relative to a
“reference” <code class="docutils literal notranslate"><span class="pre">Dataset</span></code> - see <a class="reference internal" href="reference-optimise.html"><span class="doc">Optimiser</span></a>.</p></li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Long-term average abstraction is recalculated after optimisation under the
assumption that the relative impact profile across the FDC remains constant.
However, SWABS with hands-off flow (HOF) conditions are omitted from the
recalculation at present to avoid introducing a conservative bias into the
estimates. See <a class="reference internal" href="reference-dataset.html"><span class="doc">Dataset</span></a> and <a class="reference internal" href="reference-optimise.html"><span class="doc">Optimiser</span></a> for more
details.</p>
</div>
</section>
<section id="complex-impacts">
<h3>Complex Impacts<a class="headerlink" href="#complex-impacts" title="Link to this heading"></a></h3>
<p>Exploratory and optional functionality has been included to allow specific types of
complex impacts to be included in optimisation. As noted above, the SupResGW_NBB table
thus requires a flag column to indicate whether a given complex impact (row) should be:</p>
<blockquote>
<div><ul class="simple">
<li><p>0: Excluded from optimisation</p></li>
<li><p>1: Included as a reservoir compensation flow increase</p></li>
<li><p>2: Included as a complex abstraction</p></li>
</ul>
</div></blockquote>
<p>The default is for all complex impacts to be excluded from optimisation. Thus, the
<code class="docutils literal notranslate"><span class="pre">Dataset.set_optimise_flag</span></code> method will insert a flag column of zeros, if a column
has not already been added to the table.</p>
<p>If we wish to include specific complex impacts in optimisation, we need to manually
adjust the flag column for the appropriate rows. This can be achieved in memory using
dataframe operations, for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ds</span><span class="o">.</span><span class="n">sup</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ds</span><span class="o">.</span><span class="n">sup</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="s1">&#39;complex-impact-id&#39;</span><span class="p">,</span> <span class="s1">&#39;Optimise_Flag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
<p>If we specify that a reservoir compensation flow increase is allowed in optimisation,
we also need to indicate that maximum increase permitted. This should be done for the
relevant scenarios and percentiles under consideration. For example, to permit a maximum
reservoir compensation flow increase of 5.0 Ml/d, we could do the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ds</span><span class="o">.</span><span class="n">sup</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ds</span><span class="o">.</span><span class="n">sup</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="s1">&#39;complex-impact-id&#39;</span><span class="p">,</span> <span class="s1">&#39;SUPFLQ95_MAX_INCREASE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">5.0</span>
</pre></div>
</div>
<p>Once the flag field and any maximum increase fields have been added to the relevant
<code class="docutils literal notranslate"><span class="pre">Dataset</span></code> table, the <code class="docutils literal notranslate"><span class="pre">Optimiser</span></code> can be run in the way described above. Outputs are
as detailed above, with the addition of a SupResGW_Changes table that gives any changes
to complex impacts. Note that positive numbers in this table indicate increases to
compensation flows or <em>reductions in complex abstraction impacts</em>. The latter sign
convention is opposite to that for SWABS_Changes and GWABS_Changes. It arises because
complex impacts can be positive or negative.</p>
<p>Some important points to note about the behaviour of complex impact functionality in the
<code class="docutils literal notranslate"><span class="pre">Optimiser</span></code> are:</p>
<blockquote>
<div><ul class="simple">
<li><p>Use of this functionality will typically require local knowledge of specific
impacts <em>and</em> how they have been represented in CAMS ledgers and WRGIS.</p></li>
<li><p>In its current implementation, the Optimiser seeks to minimise increases to
reservoir compensation flows in its solution for several reasons. It will only
increase a compensation flow if it helps to meet flow targets that would have
otherwise been missed. Other approaches may be explored in future.</p></li>
<li><p>Complex abstractions (flag = 2) are treated in the same way as normal surface and
groundwater abstractions. The Optimiser identifies required impact reductions for
the scenario/percentile combination in question, rather than changes to complex
licence conditions.</p></li>
<li><p>A user has the option to explore the implications of different prescribed changes
to complex impacts by editing the relevant rows in the data table and excluding
them from optimisation.</p></li>
</ul>
</div></blockquote>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="optimiser.html" class="btn btn-neutral float-left" title="Optimiser" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="fields.html" class="btn btn-neutral float-right" title="Table Fields" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Environment Agency.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>